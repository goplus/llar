import "strings"

id "freetype/freetype"

fromVer "1.0.0"

onRequire (proj, deps) => {
	// Mapping from meson dependency names to llar module paths
	depMap := make(map[string]string)
	depMap["zlib"] = "madler/zlib"
	depMap["libpng"] = "pnggroup/libpng"

	// 1. Read meson.build to discover dependency() calls
	data, err := proj.readFile("meson.build")
	if err != nil {
		return
	}
	content := string(data)

	// 2. Find each dependency('name' ...) pattern
	needle := "dependency('"
	for {
		i := strings.index(content, needle)
		if i < 0 {
			break
		}
		content = content[i+len(needle):]
		j := strings.index(content, "'")
		if j < 0 {
			break
		}
		name := content[:j]
		content = content[j+1:]

		// 3. Skip deps we don't have a module mapping for
		modPath, ok := depMap[name]
		if !ok {
			continue
		}

		// 4. Read the .wrap file to extract the pinned version
		wrapData, wrapErr := proj.readFile("subprojects/" + name + ".wrap")
		if wrapErr != nil {
			continue
		}
		wrapContent := string(wrapData)

		// Parse "directory = <name>-<version>" from the .wrap file
		dirKey := "directory = "
		di := strings.index(wrapContent, dirKey)
		if di < 0 {
			continue
		}
		rest := wrapContent[di+len(dirKey):]
		nl := strings.index(rest, "\n")
		if nl >= 0 {
			rest = rest[:nl]
		}
		rest = strings.trimSpace(rest)

		// Split "zlib-1.3.1" â†’ version "1.3.1"
		dash := strings.lastIndex(rest, "-")
		if dash < 0 {
			continue
		}
		ver := rest[dash+1:]
		deps.require modPath, "v"+ver
	}
}

onBuild (ctx, proj, out) => {
	installDir, err := ctx.outputDir()
	if err != nil {
		out.addErr err
		return
	}

	c := cmake.new(ctx.SourceDir, ctx.SourceDir+"/_build", installDir)
	c.buildType "Release"
	c.define "CMAKE_POLICY_VERSION_MINIMUM", "3.5"

	// Disable optional deps we don't provide
	c.defineBool "FT_DISABLE_HARFBUZZ", true
	c.defineBool "FT_DISABLE_BROTLI", true
	c.defineBool "FT_DISABLE_BZIP2", true

	// Require the deps we provide
	c.defineBool "FT_REQUIRE_ZLIB", true
	c.defineBool "FT_REQUIRE_PNG", true

	// Inject all dependencies via cmake.use
	for _, dep := range proj.Deps {
		depDir, err := ctx.outputDir(dep)
		if err != nil {
			out.addErr err
			return
		}
		c.use depDir
	}

	err = c.configure()
	if err != nil {
		out.addErr err
		return
	}
	err = c.build()
	if err != nil {
		out.addErr err
		return
	}
	err = c.install()
	if err != nil {
		out.addErr err
		return
	}

	// Extract link metadata from pkg-config
	c.use installDir
	capout => {
		exec "pkg-config", "--libs", "freetype2"
	}
	out.setMetadata output
}
